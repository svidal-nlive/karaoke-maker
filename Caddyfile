kapi.vectorhost.net {
    reverse_proxy api:5000 {
        header_up Host {upstream_hostport}
        header_down Access-Control-Allow-Origin "https://mydash.vectorhost.net"
        header_down Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header_down Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin, Access-Control-Request-Method, Access-Control-Request-Headers, Content-Length, Content-Disposition"
        header_down Access-Control-Allow-Credentials "true"
        header_down Access-Control-Expose-Headers "Content-Type, Authorization, Content-Length, Content-Disposition"
        header_down Access-Control-Max-Age "3600"
    }

    # Handle preflight requests
    @options {
        method OPTIONS
    }
    handle @options {
        header Access-Control-Allow-Origin "https://mydash.vectorhost.net"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin, Access-Control-Request-Method, Access-Control-Request-Headers, Content-Length, Content-Disposition"
        header Access-Control-Allow-Credentials "true"
        header Access-Control-Max-Age "3600"
        respond 204
    }

    # Add security headers
    header {
        # Security headers
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        
        # Remove Server header
        -Server
    }
    
    # Enable compression
    encode gzip
    
    # Increase timeouts for large file uploads
    timeouts {
        read_header 10s
        read_body 1h
        write 1h
        idle 1h
    }
    
    # Log all errors
    log {
        output file /var/log/caddy/kapi.vectorhost.net.log {
            roll_size 10MB
            roll_keep 10
        }
        format json
        level ERROR
    }
}
